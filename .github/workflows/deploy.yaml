name: Deploy
on: [push, pull_request]
jobs:
  deploy:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
      - name: Install cibuildwheel and twine
        run: python -m pip install cibuildwheel twine
      - name: Build wheels
        run: python -m cibuildwheel --output-dir dist
        env:
          CIBW_BEFORE_BUILD_LINUX: yum install -y zlib-devel && pip install Cython numpy
          # If there is no wheel for numpy on macOS (e.g. for PyPy3.6), we need
          # to build it using OpenBLAS, see
          # https://github.com/numpy/numpy/issues/15947#issuecomment-686159427
          CIBW_BEFORE_BUILD_MACOS: brew install openblas && OPENBLAS="$(brew --prefix openblas)" pip install Cython numpy
          CIBW_SKIP: '{cp,pp}27-* {cp,pp}35-*'
      - name: Build sdist
        if: matrix.os == 'ubuntu-latest'
        run: |
          pip install Cython numpy
          python setup.py build_ext --inplace
          python setup.py sdist
      - name: Check packages
        run: twine check dist/*
      - name: Publish to PyPI
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && github.repository_owner == 'bxlab'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
